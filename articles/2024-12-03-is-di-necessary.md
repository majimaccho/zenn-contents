---
title: "結局、DIは必要なのか？"
emoji: "🦍"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["books"]
published: false
---

https://x.com/sonatard/status/1862813057820541296
https://x.com/naoya_ito/status/1862860939336515650

最近 DI の中でも Repository について以下のような話が X で飛び交っていました。

DI はもはや不要の長物なのでしょうか？

## なぜ依存を注入するのか

[なぜ依存を注入するのか　 DI の原理・原則とパターン](https://book.mynavi.jp/ec/products/detail/id=143373)では DI を導入する目的について以下のように説明しています。

> ソフトウェア開発において依存注入は導入すること自体が目的なのではなく、目的を達成するための手段でしかありません。依存注入を導入するためにインターフェースを介する設計にすることでオブジェクト間の関係は疎結合になり、その結果、保守容易性が向上します。

つまり、DI は疎結合にするための方法の 1 つということになります。
疎結合であることの具体的なメリットとして、同書の中では拡張可能性、保守性、テスト容易性などが挙げられていました。

## DI のデメリット

DI を利用して疎結合なソフトウェアを作ることにはメリットがある一方で、トレードオフとなるデメリットもあります。
その一つはデータの詰め替えが多くなってしまい、コードベースの多くを詰め替えのためのコードに割かなければならなくなることです。

[kawasima さんの「データ詰め替え戦略」](https://scrapbox.io/kawasima/%E3%83%87%E3%83%BC%E3%82%BF%E8%A9%B0%E3%82%81%E6%9B%BF%E3%81%88%E6%88%A6%E7%95%A5)の中で、Clean Architecture で Full Mapping している場合と Ruby on Rails の比較がされており、比較して見ると詰め替えのコード量の差がわかりやすいと思います。

Clean Architecture で Full Mapping している場合
![Clean ArchitectureでFull Mappingしている場合詰め替えが4箇所で発生する](/images/kawasima_clean_arch_full_mapping.png)

全く Mapping を行わない Ruby on Rails
![全くMappingを行わないRuby on Rails](/images/kawasima_rails_no_mapping.png)

1 つのユースケースのみを実装するのであれば、マッピングを行わない設計の方が実装が早く終わることは明らかですし、全て密結合させてしまうことは保守性の低下を招きやすいことは確かです。（Ruby on Rails のコミュニティではこうした特徴を受けて、フレームワーク特有の設計プラクティスが蓄積されているようです。）

## データベースの DI

書籍[単体テストの考え方・使い方](https://book.mynavi.jp/ec/products/detail/id=134252)で結合テストでは、管理下にある依存、つまり、テスト対象のアプリケーションからしかアクセスされない依存について、以下のように述べられています。

> 外部から観察できないプロセス外依存とのコミュニケーションは実装の詳細になる。つまり、そのコミュニケーションプロセスに対してリファクタリングを行う場合、同じデータ構造を持つことも、同じ手順を踏むことも維持する必要がなくなる。そのため、このような依存はモックを持って検証すべきではない。

このような、管理下にあるプロセス外依存の代表的な例として、アプリケーションコードと同じ場所でスキーマの管理をされている DB が挙げられています。
つまり、テストという観点では管理下にある DB アクセスへの依存を注入する必要はないということになります。

## 関数型における DI

書籍[関数型ドメインモデリング](https://tatsu-zine.com/books/domain-modeling-made-functional)と
[Six approaches to dependency injection](https://fsharpforfunandprofit.com/posts/dependencies/)の中で

I/O を処理の開始と終了の両端に追いやることでドメインロジックを純粋に保つことができるという考え方が紹介されています。

ドメインロジックに関してはテストが容易な状態になっており、

ユースケース、コントローラーと呼ばれる、プロセス外依存と通信を行うレイヤーでは管理された依存である DB についてはモックせずそのままテストするが良いので、テストの観点では Repository は不要ということになります。

ただし、管理された依存ではない、外部 API などを扱うときや、DB アクセスの処理が複雑な場合、モックする必要があり、

## 必要な DI

DI の機能として

- 合成
- 介入
-

<!-- Web APIでDIから得られるメリットは
コードの疎結合さとテストの容易性（依存をなぜ注入するのか）で
RDBについては管理されたプロセス外依存なので、ちゃんと結合テストで本物を使った方が良い→この観点では不要
ドメイン層についてはIOを処理の開始と終了の両端に配置することで、プロセス外依存を含まない純粋関数にすることができる（単体テストの考え方、使い方と関数型ドメインモデリングそれぞれで紹介）
どの程度、疎結合さを必要とするかによって
Repositoryの分割はするが、インターフェースをドメイン層に持たせない
そもそも分割しない
というオプションがある
ドメイン駆動設計を始めようでは
ドメインの複雑さによってトランザクションスクリプトとドメインモデルパターンを選択するという考え方が紹介されている。 -->
